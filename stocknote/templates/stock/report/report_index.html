<h3 class="text-center text-primary">{{stock.name}}({{ stock.code}})</h3>
<br><br>
<div class="row">
    <div class="col-md-11">
        <div class="row text-muted">
            <div class="alert alert-warning" role="alert">
                <h6>分析要点</h6>
                <ol>
                    <li><small>这是个什么样的生意？(毛利率、净利率、费用、现金流等情况,分解ROE判断公司经营是低利润率高周转率，还是高利润率低周转率，还是杠杆型)</small></li>
                    <li><small>它的市场空间有多大？</small></li>
                    <li><small>它是否有竞争优势？(比如：客户为什么选择它而不选择其他竞争者？为什么其他资本没有提供更高性价比的商品和服务，抢占它的市场份额？如果同行或新进者裹挟巨资参与竞争，该公司是否可以保持住乃至扩张自己的市场份额？)</small></li>
                    <li><small>经营的历史和未来态势怎么样?</small></li>
                    <li><small>主要的风险是什么？</small></li>
                    <li><small>估值多少？</small></li>
                </ol>
            </div>
        </div>
        <br><br>
        <div class="row">
            <h5 class="text-success" id="annualReport"><i class="glyphicon glyphicon-link"></i> 年度报告</h5>
            <hr><br>
            <ul>
                <li><a href="http://money.finance.sina.com.cn/corp/go.php/vCB_Bulletin/stockid/{{stock.code}}/page_type/ndbg.phtml"
                        target="_blank">年度报告&gt;&gt;</a></li>
                <li>
                    <a href="http://stockdata.stock.hexun.com/2009_zcfz_{{ stock.code }}.shtml"
                        target="_blank">财务数据&gt;&gt;</a>
                </li>
            </ul>
        </div>
        <br>
        <div class="row">
            <h5 class="text-success" id="basicInfo"><i class="glyphicon glyphicon-info-sign"></i> 基本情况</h5>
            <hr><br>
            <div class="col-md-12">
                <div id="J_basicInfoTable"></div>
            </div>
            <div class="col-md-12">
                <div id="J_briefBalanceSheetTable"></div>
            </div>
            <div class="col-md-12">
                <div id="J_assetStructureTable"></div>
            </div>
        </div>
        <br>
        <div class="row">
            <h5 class="text-success" id="competitiveEdge"><i class="glyphicon glyphicon-star"></i> 竞争优势</h5>
            <hr>
            <div class="col-md-12">
                <p>通过分析公司自由现金流、毛利率、净资产收益率、资产收益率来检验公司过去的盈利能力怎样，寻找竞争优势的证据(最好还要找同行业的其他公司做对比)。若公司显示较强的盈利能力，则进一步分析公司是否某方面的竞争优势，这些竞争优势有可能是:
                </p>
                <ul>
                    <li>通过出众的技术或特色创造真实的差异化产品</li>
                    <li>通过一个信任的品牌或声誉创造可感知的差异化产品</li>
                    <li>降低成本并以更低的价格提供相似的产品和服务</li>
                    <li>通过创造高的转换成本锁定消费者</li>
                    <li>通过建立高进入壁垒把竞争者阻挡在外面</li>
                </ul>
                <br>
            </div>
            <div class="col-md-12">
                <!-- Nav tabs -->
                <ul class="nav nav-tabs" role="tablist">
                    <li role="presentation" class="active"><a href="#i_profitabilityIndicators"
                            aria-controls="i_profitabilityIndicators" role="tab" data-toggle="tab">盈利能力指标</a></li>
                    <li role="presentation"><a href="#i_ROEAnalysis" aria-controls="i_ROEAnalysis"
                            role="tab" data-toggle="tab">ROE分析</a></li>
                    <li role="presentation"><a href="#i_fiveForcesAnalysis" aria-controls="i_fiveForcesAnalysis"
                        role="tab" data-toggle="tab">五力分析</a></li>
                    <li role="presentation"><a href="#i_freeCashFlow" aria-controls="i_freeCashFlow" role="tab"
                            data-toggle="tab">历史自由现金流</a></li>
                </ul>
                <br>
                <!-- Tab panes -->
                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="i_profitabilityIndicators">
                        <div id="J_profitabilityIndicatorsChart" style="width: 600px;height:300px;"></div>
                        <div><a data-toggle="collapse" data-target="#i_thresholds">参考阈值<i
                                    class="ri-information-line"></i></a>
                        </div>
                        <br>
                        <div id="i_thresholds" class="collapse text-muted">
                            <small>
                                <ul>
                                    <li>净利润率 >= 15%</li>
                                    <li>ROA >= 6%</li>
                                    <li>ROE >= 10%</li>
                                </ul>
                            </small>
                        </div>
                        <br>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="i_ROEAnalysis">
                        <div id="J_ROEAnalysisTable"></div>
                        <br>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="i_fiveForcesAnalysis">
                        <div id="J_fiveForcesTable"></div>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="i_freeCashFlow">
                        <div id="J_freeCashFlowTable"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <h5 class="text-success" id="growth"><i class="glyphicon glyphicon-signal"></i> 成长性</h5>
            <hr><br>
            <div class="col-md-12">
                <!-- Nav tabs -->
                <ul class="nav nav-tabs" role="tablist">
                    <li role="presentation" class="active"><a href="#i_growthRevenue" aria-controls="i_growthRevenue"
                            role="tab" data-toggle="tab">营业收入</a></li>
                    <li role="presentation"><a href="#i_growthNetProfit" aria-controls="i_growthNetProfit" role="tab"
                            data-toggle="tab">净利润</a></li>
                    <li role="presentation"><a href="#i_growthNetProfitNrgal" aria-controls="i_growthNetProfitNrgal"
                            role="tab" data-toggle="tab">扣非净利润</a></li>
                    <li role="presentation"><a href="#i_totalHoldersEquity" aria-controls="i_totalHoldersEquity"
                            role="tab" data-toggle="tab">净资产</a></li>
                    <li role="presentation"><a href="#i_totalAssets" aria-controls="i_totalAssets"
                        role="tab" data-toggle="tab">总资产</a></li>
                </ul>
                <br>
                <!-- Tab panes -->
                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="i_growthRevenue">
                        <div id="J_growthRevenueChart" style="width: 600px;height:300px;"></div>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="i_growthNetProfit">
                        <div id="J_growthNetProfitChart" style="width: 600px;height:300px;"></div>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="i_growthNetProfitNrgal">
                        <div id="J_growthNetProfitNrgalChart" style="width: 600px;height:300px;"></div>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="i_totalHoldersEquity">
                        <div id="J_totalHoldersEquityChart" style="width: 600px;height:300px;"></div>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="i_totalAssets">
                        <div id="J_totalAssetsChart" style="width: 600px;height:300px;"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-12">
                <div class="alert alert-warning" role="alert">
                    <p>若公司表现出高增长，则需要注意，高增长的历史记录并不能保证公司未来还能继续保持高速增长，需要进一步调查分析其
                        <a data-toggle="popover" data-placement="top" data-trigger="hover" data-html=true
                            data-title="可能的成长来源"
                            data-content="&lt;ul class=&quot;list-unstyled&quot;&gt;&lt;li&gt;1.销售更多的产品或服务(销量增长或市场份额增加)&lt;/li&gt;&lt;li&gt;2.提高价格(凭借品牌或垄断地位)&lt;/li&gt;&lt;li&gt;3.销售新的产品或服务&lt;/li&gt;&lt;li&gt;4.购买其他公司&lt;/li&gt;&lt;/ul&gt;">成长性的来源<i
                                class="ri-information-line"></i>
                        </a>
                        和该成长性是否具有
                        <a data-toggle="popover" data-trigger="hover" data-placement="top" title="质询成长质量"
                            data-content="销售增长和进入一个新市场带来的高质量成长，比单靠降价和会计作假带来的低质量成长更具有可持续性；销售增长是很难伪造的，而推进盈利增长的欺骗方法很多，所以一般而言，任何一家公司盈利增长超过销售增长持续一段时间(比如5~10年)，你就需要深挖这些数字(比如是不是有削减成本、税率降低、一次性损益等不可持续的行为)。另外，收购通常是个质量很低的增长途径。">可持续性<i
                                class="ri-information-line"></i>
                        </a>。
                    </p>
                </div>
            </div>
        </div>
        <br>
        <div class="row">
            <h5 class="text-success" id="profitability"><i class="glyphicon glyphicon-piggy-bank"></i> 收益性</h5>
            <hr><br>
            <div class="col-md-12">
                <h5 class="text-center">百分率利润表 - {{stock.name}}</h5>
                <div id="J_incomePercentageTable"></div>
            </div>
            <div class="col-md-12">
                <p>深入挖掘公司是怎么赚钱的</p>
            </div>
        </div>
        <br>
        <div class="row">
            <h5 class="text-success" id="OperationCapability"><i class="glyphicon glyphicon-refresh"></i> 营运能力</h5>
            <hr><br>
            <div class="col-md-12">
                <div id="J_operationCapabilityTable"></div>
            </div>
        </div>       
        <br>
        <div class="row">
            <h5 class="text-success" id="financialRisk"><i class="glyphicon glyphicon-heart"></i> 财务风险</h5>
            <hr><br>
            <div class="col-md-12">
                <div id="J_financialRiskTable"></div>
            </div>
            <div class="col-md-12">
                <div><a data-toggle="collapse" data-target="#i_finDesc">指标解读 <i class="ri-information-line"></i></a>
                </div>
                <br>
                <div class="collapse text-muted" id="i_finDesc">
                    <small>
                        <p>对于财务健康状况来说，当公司增加负债时，同时也增加了公司的固定费用，它占总费用一定的百分比，在公司生意好的年份里，高固定费用的公司盈利非常好，因为一旦支付完这些费用，所有额外的销售收入就直接计入自己的账上了；而当生意不好的时候，债务的固定费用会把盈利降得相当低。
                        </p>
                        <ul>
                            <li>低流动比率意味着公司没有足够的现金来源来偿还即将到期的债务，这就迫使公司在外面寻找融资，或者把营业收入用于偿债。一般而言，流动比率保持在 1.5
                            左右的公司能够应对正常运营之需，不会遇到太大的麻烦。</li>
                            <li>速动比率对制造业和零售业公司特别有用，因为这两类公司中存货占用了大量资金，这些存货也许没有它们在资产负债表上的价值值钱。通常速动比率高于 1.0
                                被视为公司处于比较好的状态，但是一定要对照看一下同行业其他公司的实际情况。</li>
                            <li>现金债务比 = 货币现金 / 有息负债 = 货币现金 / (短期借款 + 交易性金融资产 + 长期借款 + 应付债券 + 一年到期的非流动负债)</li>
                        </ul>
                    </small>
                </div>
            </div>
        </div>
        <br>
        <div class="row">
            <h5 class="text-success" id="abnormalRisk"><i class="glyphicon glyphicon-warning-sign"></i> 排雷</h5>
            <hr><br>
            <div class="col-md-12">
                <div id="J_warningCurrencyFunds"></div>
            </div>
            <div class="col-md-12">
                <div id="J_warningAccountReceivable"></div>
            </div>
            <div class="col-md-12">
                <div id="J_warningOtherAssets"></div>
            </div>
        </div>
    </div>
    <div class="col-md-1" role="complementary">
        <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix bg-info">
            <ul class="nav bs-docs-sidenav">
                <li class="active"><a href="#annualReport"> - 年度报告</a></li>
                <li><a href="#basicInfo"> - 基本情况</a></li>
                <li><a href="#competitiveEdge"> - 竞争优势</a></li>
                <li><a href="#growth"> - 成长性</a></li>
                <li><a href="#profitability"> - 收益性</a></li>
                <li><a href="#OperationCapability"> - 营运能力</a></li>
                <li><a href="#financialRisk"> - 财务风险</a></li>
                <li><a href="#abnormalRisk"> - 排雷</a></li>
                <li><a role="button" class="text-muted" data-toggle="collapse" data-target="#i_updateData">无报表数据？</a></li>
                    <div id="i_updateData" class="collapse text-center">
                        <button class="btn btn-success btn-xs" type="button"
                        data-url="{{ url_for('individual.api_op_shell_crawl_data', code=stock.code) }}"
                        onclick="crawlData(this)">
                        爬取数据
                        </button>
                    </div>
            </ul>
        </nav>
    </div>
</div>


<!-- Modal for edit basic info -->
<div class="modal fade" id="i_editBasicInfoModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="i_editBasicInfoModalLabel"></h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <textarea class="form-control" rows="3" id="i_basicInfoTextArea" data-field=""></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="editBasicInfo()">确认</button>
            </div>
        </div>
    </div>
</div>

<!-- 加载状态 -->
<div class="loading" hidden>
    <p style="text-align:center; position: relative; top:40%" >
        <img class="gif" src='/static/images/loading2.gif' style="height:160px;"/>
    </p>
</div>


<script>
    // 百分率利润表
    var income_percentage_url = "{{ url_for('stock.api_data_income_percentage', code=stock.code) }}";
    // 自由现金流量表
    var free_cashflow_url = "{{ url_for('stock.free_cashflow', code=stock.code) }}";
    // 公司基本信息
    var basic_info_url = "{{ url_for('stock.api_data_basic_info', code=stock.code) }}";
    var basic_info_partial_url = "{{ url_for('stock.api_data_partial_basic_info', code=stock.code) }}";
    var basic_info_edit_url = "{{ url_for('stock.api_op_edit_basic_info') }}";
    // brief balance sheet
    var brief_balance_sheet_url = "{{ url_for('stock.api_data_brief_balance_sheet', code=stock.code) }}";
    // asset structure
    var asset_structure_url = "{{ url_for('stock.api_data_asset_structure', code=stock.code) }}";
    // roe分析
    var roe_analysis_url = "{{ url_for('stock.api_data_roe_analysis', code=stock.code) }}";
    // 五力分析
    var five_forces_url = "{{ url_for('stock.api_data_five_forces', code=stock.code) }}";
    // 营运能力
    var operation_capability_url = "{{ url_for('stock.api_data_operation_capability', code=stock.code) }}";
    // 财务健康指标表格
    var financial_risk_url = "{{ url_for('stock.api_data_financial_risk', code=stock.code) }}";
    // 异常数据
    var warning_currency_funds_url = "{{ url_for('stock.api_data_warning_currency_funds', code=stock.code) }}";
    var warning_account_receivable_url = "{{ url_for('stock.api_data_warning_account_receivable', code=stock.code) }}";
    var warning_other_assets_url = "{{ url_for('stock.api_data_warning_other_assets', code=stock.code) }}";

    // 显示公司基本信息编辑框
    function showBasicInfoEditModal(obj) {
        var name = $(obj).attr("data-name");
        var field = $(obj).attr("data-field");
        $("#i_editBasicInfoModalLabel").text(name);
        $("#i_basicInfoTextArea").attr("data-field", field);
        
        $.ajax({
            type: 'GET',
            url: basic_info_partial_url,
            data: { "field": field},
            contentType: 'application/json;charset=UTF-8',
            success: function (response) {
                $("#i_basicInfoTextArea").val(response.data.desc);
                $("#i_editBasicInfoModal").modal("show");
            }
        });
        
    }
    
    function editBasicInfo() {
        var cont = $("#i_basicInfoTextArea").val();
        var field = $("#i_basicInfoTextArea").attr("data-field");
        var code = $("#i_brc").attr("data-code");

        var params = { "field": field, "value": cont, "code": code};
        $.ajax({
            type: 'PATCH',
            url: basic_info_edit_url,
            data: JSON.stringify(params),
            contentType: 'application/json;charset=UTF-8',
            success: function (response) {
                alert(response["message"]);
                loadContentV2(basic_info_url, "J_basicInfoTable");
            }
        });
    }

    function crawlData(obj){
        $('.loading').show(); // 显示加载状态

        var url = $(obj).attr("data-url");
        $.ajax({
            type: 'GET',
            url: url,
            success: function (response) {
                //alert(response["message"]);
                //location.reload()  // 刷新页面
                $("#navbar li.active > a").click()  // 刷新重载页面
                $('.loading').hide();　// 隐藏加载状态
            }
        });
    }

    $(function () {
        $('[data-toggle="popover"]').popover();   // 初始化bootstrap的弹出框

        loadContent(free_cashflow_url, "J_freeCashFlowTable");
        
        loadContentV2(basic_info_url, "J_basicInfoTable");
        loadContentV2(brief_balance_sheet_url, "J_briefBalanceSheetTable");
        loadContentV2(asset_structure_url, "J_assetStructureTable");
        loadContentV2(five_forces_url, "J_fiveForcesTable");
        loadContentV2(roe_analysis_url, "J_ROEAnalysisTable");
        loadContentV2(income_percentage_url, "J_incomePercentageTable");
        loadContentV2(financial_risk_url, "J_financialRiskTable");
        loadContentV2(operation_capability_url, "J_operationCapabilityTable");
        loadContentV2(warning_currency_funds_url, "J_warningCurrencyFunds")
        loadContentV2(warning_account_receivable_url, "J_warningAccountReceivable")
        loadContentV2(warning_other_assets_url, "J_warningOtherAssets")

        // 成长性相关曲线图
        var revenue_url = "{{ url_for('stock.api_data_revenue', code=stock.code) }}";
        var net_profit_nrgal_url = "{{ url_for('stock.api_data_net_profit_nrgal', code=stock.code) }}";
        var net_profit_url = "{{ url_for('stock.api_data_net_profit', code=stock.code) }}";
        var total_holders_equity_url = "{{ url_for('stock.api_data_total_holders_equity', code=stock.code) }}";
        var total_assets_url = "{{ url_for('stock.api_data_total_assets', code=stock.code) }}";

        getDataAndPlotBar(revenue_url, "J_growthRevenueChart");
        getDataAndPlotBar(net_profit_nrgal_url, "J_growthNetProfitNrgalChart");
        getDataAndPlotBar(net_profit_url, "J_growthNetProfitChart");
        getDataAndPlotBar(total_holders_equity_url, "J_totalHoldersEquityChart");
        getDataAndPlotBar(total_assets_url, "J_totalAssetsChart");

        // 盈利能力相关曲线图
        var profitability_url = "{{ url_for('stock.api_data_profitablity', code=stock.code) }}";
        getDataAndPlotLines(profitability_url, "J_profitabilityIndicatorsChart");
    });
</script>